<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate DC & Logic Lab - Dark Edition</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-color: #1e1e1e;
            --accent-color: #03a9f4;
            --wire-off: #37474f;
            --wire-on: #ffee58;
            --danger: #ff5252;
            --text-main: #e0e0e0;
            --text-dim: #90a4ae;
            --border-color: #333333;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: var(--bg-color); color: var(--text-main); }
        #app { display: flex; width: 100vw; height: 100vh; position: relative; }

        #menu-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 45px;
            height: 45px;
            background: var(--panel-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px;
        }
        #menu-toggle span { width: 24px; height: 3px; background: var(--accent-color); border-radius: 2px; }

        #toolbox {
            width: var(--sidebar-width);
            background: var(--panel-color);
            border-right: 2px solid var(--border-color);
            display: flex; flex-direction: column; padding: 15px; overflow-y: auto;
            z-index: 999; height: 100vh; transition: transform 0.3s ease;
        }
        #toolbox.collapsed { transform: translateX(-100%); position: absolute; }

        h2 { margin-top: 0; color: var(--accent-color); font-size: 1.1rem; border-bottom: 2px solid var(--accent-color); padding-bottom: 8px; padding-top: 45px; }
        h3 { font-size: 0.8rem; color: var(--text-dim); margin: 15px 0 5px 0; text-transform: uppercase; letter-spacing: 1px; }

        .tool-item {
            background: #2c2c2c; border: 1px solid #444; border-radius: 8px;
            padding: 8px 12px; margin-bottom: 6px; cursor: pointer; 
            display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-size: 13px;
        }
        .tool-item:hover { background: #3d3d3d; border-color: var(--accent-color); transform: translateX(3px); }
        .tool-item.placing { background: var(--accent-color); color: #000; }
        .tool-icon { width: 30px; height: 22px; background: #121212; border: 1px solid #555; display: flex; justify-content: center; align-items: center; font-size: 10px; border-radius: 4px; color: var(--accent-color); }

        #workspace-container { flex-grow: 1; position: relative; overflow: hidden; background-color: #0a0a0a; }
        #workspace { 
            position: absolute; 
            width: 5000px; 
            height: 5000px; 
            background-image: radial-gradient(#222 1px, transparent 1px); 
            background-size: 25px 25px; 
        }
        #workspace.placing-mode { cursor: crosshair; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }

        .component {
            position: absolute; background: #252525; border: 2px solid #444; border-radius: 6px;
            padding: 8px; cursor: move; display: flex; flex-direction: column; align-items: center;
            min-width: 80px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); user-select: none;
            transition: transform 0.1s;
        }
        .component:hover { transform: scale(1.02); }
        .component.selected { border-color: var(--accent-color); box-shadow: 0 0 15px rgba(3, 169, 244, 0.3); }
        .component-label { font-size: 10px; font-weight: bold; color: var(--text-dim); margin-bottom: 4px; text-transform: uppercase; }
        
        .node { width: 12px; height: 12px; background: #121212; border: 2px solid #666; border-radius: 50%; position: absolute; cursor: crosshair; z-index: 5; transition: all 0.2s; }
        .node:hover { transform: scale(1.4); background: var(--accent-color); border-color: var(--accent-color); }
        .node.input { left: -8px; }
        .node.output { right: -8px; }
        .node.active { background: var(--wire-on); border-color: var(--wire-on); animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px var(--wire-on); }
            50% { box-shadow: 0 0 15px var(--wire-on); }
        }

        .readout { font-family: 'Courier New', monospace; background: #000; color: #00ff41; padding: 4px 8px; border-radius: 3px; font-size: 12px; margin-top: 4px; min-width: 60px; text-align: center; }
        .switch-btn { width: 40px; height: 22px; background: #444; border-radius: 12px; position: relative; cursor: pointer; transition: 0.3s; }
        .switch-btn.on { background: #2e7d32; }
        .switch-btn::after { content: ''; position: absolute; width: 18px; height: 18px; background: #eee; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .switch-btn.on::after { transform: translateX(18px); }

        .btn-momentary { width: 30px; height: 30px; background: #b71c1c; border-radius: 50%; border: 3px solid #7f0000; cursor: pointer; transition: 0.1s; box-shadow: 0 3px 6px rgba(0,0,0,0.3); }
        .btn-momentary:active { transform: translateY(2px); box-shadow: 0 1px 3px rgba(0,0,0,0.3); background: #d32f2f; }
        .light-bulb { width: 30px; height: 30px; border-radius: 50%; background: #333; transition: 0.2s; border: 2px solid #111; }
        .fuse-wire { width: 35px; height: 5px; background: linear-gradient(90deg, #4fc3f7, #81d4fa); border-radius: 2px; }
        .fuse-wire.blown { background: #000; opacity: 0.3; }

        .capacitor-visual { display: flex; gap: 2px; }
        .capacitor-plate { width: 3px; height: 20px; background: #64b5f6; }
        
        .resistor-visual { width: 40px; height: 8px; background: repeating-linear-gradient(90deg, #8d6e63 0px, #8d6e63 4px, #6d4c41 4px, #6d4c41 8px); border-radius: 2px; }

        .seven-seg { 
            display: grid; 
            grid-template-areas: 
                " . a . " 
                " f . b " 
                " . g . " 
                " e . c " 
                " . d . "; 
            gap: 2px; 
            background: #000; 
            padding: 8px; 
            border-radius: 4px; 
        }
        .seg { background: #1a1a1a; border-radius: 1px; transition: 0.1s; }
        .seg-h { width: 24px; height: 4px; }
        .seg-v { width: 4px; height: 18px; }
        .seg.on { background: #ff1744; box-shadow: 0 0 8px #ff1744; }
        
        #a { grid-area: a; } #b { grid-area: b; } #c { grid-area: c; }
        #d { grid-area: d; } #e { grid-area: e; } #f { grid-area: f; } #g { grid-area: g; }

        .logic-gate { width: 50px; height: 40px; display: flex; align-items: center; justify-content: center; background: #1a237e; border-radius: 4px; color: #fff; font-weight: bold; font-size: 16px; }

        #props-panel { 
            position: absolute; right: 20px; top: 20px; width: 220px; 
            background: #1e1e1e; border: 2px solid #444; border-radius: 10px; 
            padding: 12px; display: none; z-index: 100; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .delete-btn { 
            position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; 
            background: var(--danger); color: white; border-radius: 50%; 
            display: none; justify-content: center; align-items: center; 
            cursor: pointer; font-weight: bold; font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .component:hover .delete-btn { display: flex; }
        .delete-btn:hover { background: #d32f2f; transform: scale(1.1); }
        
        button#reset-btn { 
            margin-top: 20px; padding: 10px; background: #37474f; 
            color: white; border: none; border-radius: 5px; cursor: pointer; 
            width: 100%; transition: 0.2s;
        }
        button#reset-btn:hover { background: #455a64; }
        
        .prop-label { color: var(--text-dim); font-size: 11px; margin-top: 8px; }
        .prop-value { color: var(--accent-color); font-weight: bold; }
        input[type="range"] { width: 100%; margin: 5px 0; }
        
        .placing-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-color);
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid var(--accent-color);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>

<div id="app">
    <div id="menu-toggle"><span></span><span></span><span></span></div>
    <div id="toolbox">
        <h2>‚ö° Dark Lab</h2>
        <div id="tool-list"></div>
        <button id="reset-btn">üîÑ Reset All</button>
    </div>

    <div id="workspace-container">
        <div id="workspace">
            <canvas id="wireCanvas"></canvas>
        </div>
        <div id="props-panel">
            <h3 style="margin-top:0">‚öôÔ∏è Properties</h3>
            <div id="props-content"></div>
        </div>
    </div>
    
    <div class="placing-hint" id="placing-hint">Click on workspace to place component (ESC to cancel)</div>
</div>

<script>
    const workspace = document.getElementById('workspace');
    const canvas = document.getElementById('wireCanvas');
    const ctx = canvas.getContext('2d');
    const propsPanel = document.getElementById('props-panel');
    const propsContent = document.getElementById('props-content');
    const placingHint = document.getElementById('placing-hint');
    const toolList = document.getElementById('tool-list');
    
    let components = [], wires = [], activeWireStart = null, selectedComponent = null, isDragging = null;
    let dragOffsetX = 0, dragOffsetY = 0;
    let placingType = null; // Track which component type we're placing

    const TOOL_DATA = {
        'Power': { 
            BATTERY: { icon: 'üîã', inputs: 0, outputs: 1 },
            CLOCK: { icon: '‚è∞', inputs: 0, outputs: 1 },
            SWITCH: { icon: '‚èª', inputs: 1, outputs: 1 },
            BUTTON: { icon: 'üîò', inputs: 0, outputs: 1 }
        },
        'Logic': { 
            AND: { icon: '&', inputs: 2, outputs: 1 },
            OR: { icon: '‚â•1', inputs: 2, outputs: 1 },
            NOT: { icon: '¬¨', inputs: 1, outputs: 1 },
            XOR: { icon: '‚äï', inputs: 2, outputs: 1 },
            NAND: { icon: '‚äº', inputs: 2, outputs: 1 },
            NOR: { icon: '‚äΩ', inputs: 2, outputs: 1 }
        },
        'Passive': { 
            RESISTOR: { icon: 'Œ©', inputs: 1, outputs: 1 },
            CAPACITOR: { icon: '||', inputs: 1, outputs: 1 },
            FUSE: { icon: '‚Äî', inputs: 1, outputs: 1 }
        },
        'Memory': { 
            SR_LATCH: { icon: 'SR', inputs: 2, outputs: 1 },
            D_FF: { icon: 'D', inputs: 2, outputs: 1 }
        },
        'Output': { 
            LIGHT: { icon: 'üí°', inputs: 1, outputs: 0 },
            '7SEG': { icon: '8', inputs: 7, outputs: 0 }
        },
        'Meters': { 
            VOLTMETER: { icon: 'V', inputs: 2, outputs: 0 },
            AMMETER: { icon: 'A', inputs: 1, outputs: 1 }
        }
    };

    // Initialize Tool List
    for (const [cat, tools] of Object.entries(TOOL_DATA)) {
        const h = document.createElement('h3'); 
        h.innerText = cat; 
        toolList.appendChild(h);
        
        for (const [type, data] of Object.entries(tools)) {
            const div = document.createElement('div');
            div.className = 'tool-item';
            div.draggable = true;
            div.innerHTML = `<div class="tool-icon">${data.icon}</div><span>${type.replace('_',' ')}</span>`;
            
            // Click to place mode
            div.onclick = () => startPlacingMode(type, div);
            
            // Drag to place
            div.ondragstart = (e) => {
                e.dataTransfer.setData('type', type);
                e.dataTransfer.effectAllowed = 'copy';
            };
            
            toolList.appendChild(div);
        }
    }

    function startPlacingMode(type, toolElement) {
        // Clear any previous placing mode
        document.querySelectorAll('.tool-item').forEach(item => item.classList.remove('placing'));
        
        if (placingType === type) {
            // Toggle off if clicking the same tool
            placingType = null;
            workspace.classList.remove('placing-mode');
            placingHint.style.display = 'none';
        } else {
            placingType = type;
            toolElement.classList.add('placing');
            workspace.classList.add('placing-mode');
            placingHint.style.display = 'block';
        }
    }

    class Component {
        constructor(type, x, y) {
            this.type = type; 
            this.id = 'c' + Math.random().toString(36).substr(2, 5);
            this.x = x; 
            this.y = y; 
            this.voltageOut = 0; 
            this.value = type === 'BATTERY' ? 9 : type === 'CLOCK' ? 1000 : 1;
            this.state = 0;
            this.inputs = []; 
            this.blown = false; 
            this.lastClock = false;
            this.capacitorCharge = 0;

            this.el = document.createElement('div');
            this.el.className = 'component';
            this.el.style.left = x + 'px'; 
            this.el.style.top = y + 'px';
            this.el.innerHTML = `<div class="component-label">${type.replace('_', ' ')}</div><div class="delete-btn">√ó</div>`;
            this.el.querySelector('.delete-btn').onclick = () => this.remove();

            this.buildUI();
            this.createNodes();

            this.el.onmousedown = (e) => this.onStartDrag(e);
            workspace.appendChild(this.el);
        }

        buildUI() {
            const content = document.createElement('div');
            content.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:4px;';

            switch(this.type) {
                case 'BATTERY':
                    content.innerHTML = `<div style="font-size:24px">üîã</div><div class="readout">${this.value}V</div>`;
                    break;
                case 'CLOCK':
                    content.innerHTML = `<div style="font-size:24px">‚è∞</div><div class="readout">${this.value}ms</div>`;
                    break;
                case 'SWITCH':
                    const sw = document.createElement('div');
                    sw.className = 'switch-btn';
                    sw.onclick = (e) => { 
                        e.stopPropagation(); 
                        this.state = !this.state; 
                        sw.classList.toggle('on', this.state); 
                    };
                    content.appendChild(sw);
                    break;
                case 'BUTTON':
                    const btn = document.createElement('div');
                    btn.className = 'btn-momentary';
                    btn.onmousedown = (e) => { e.stopPropagation(); this.state = 1; };
                    btn.onmouseup = () => { this.state = 0; };
                    btn.onmouseleave = () => { this.state = 0; };
                    content.appendChild(btn);
                    break;
                case 'RESISTOR':
                    content.innerHTML = `<div class="resistor-visual"></div><div class="readout">${this.value}Œ©</div>`;
                    break;
                case 'CAPACITOR':
                    content.innerHTML = `<div class="capacitor-visual"><div class="capacitor-plate"></div><div class="capacitor-plate"></div></div><div class="readout">${this.value}¬µF</div>`;
                    break;
                case 'FUSE':
                    content.innerHTML = `<div class="fuse-wire"></div><div class="readout">${this.value}A</div>`;
                    break;
                case 'LIGHT':
                    content.innerHTML = `<div class="light-bulb"></div>`;
                    break;
                case 'AND':
                case 'OR':
                case 'NOT':
                case 'NAND':
                case 'NOR':
                case 'XOR':
                    content.innerHTML = `<div class="logic-gate">${TOOL_DATA.Logic[this.type].icon}</div>`;
                    break;
                case 'SR_LATCH':
                    content.innerHTML = `<div class="logic-gate">SR</div><div style="font-size:9px;color:#666">S R Q</div>`;
                    break;
                case 'D_FF':
                    content.innerHTML = `<div class="logic-gate">D</div><div style="font-size:9px;color:#666">D CLK Q</div>`;
                    break;
                case '7SEG':
                    content.innerHTML = `
                        <div class="seven-seg">
                            <div id="${this.id}a" class="seg seg-h"></div>
                            <div id="${this.id}f" class="seg seg-v"></div>
                            <div id="${this.id}b" class="seg seg-v"></div>
                            <div id="${this.id}g" class="seg seg-h"></div>
                            <div id="${this.id}e" class="seg seg-v"></div>
                            <div id="${this.id}c" class="seg seg-v"></div>
                            <div id="${this.id}d" class="seg seg-h"></div>
                        </div>`;
                    break;
                case 'VOLTMETER':
                    content.innerHTML = `<div style="font-size:20px">üìä</div><div class="readout">0.00V</div>`;
                    break;
                case 'AMMETER':
                    content.innerHTML = `<div style="font-size:20px">‚ö°</div><div class="readout">0.00A</div>`;
                    break;
            }
            this.el.appendChild(content);
        }

        createNodes() {
            const toolData = Object.values(TOOL_DATA).find(cat => cat[this.type])?.[this.type];
            if (!toolData) return;

            const numInputs = toolData.inputs;
            const numOutputs = toolData.outputs;

            for (let i = 0; i < numInputs; i++) {
                const n = document.createElement('div');
                n.className = 'node input';
                n.style.top = `${25 + i * 20}px`;
                n.onmousedown = (e) => { e.stopPropagation(); };
                n.onmouseup = (e) => {
                    e.stopPropagation();
                    if (activeWireStart) {
                        wires.push({ from: activeWireStart.comp, fromIdx: activeWireStart.idx, to: this, toIdx: i });
                        activeWireStart = null;
                    }
                };
                this.el.appendChild(n);
            }

            for (let i = 0; i < numOutputs; i++) {
                const n = document.createElement('div');
                n.className = 'node output';
                n.style.top = `${25 + i * 20}px`;
                n.onmousedown = (e) => {
                    e.stopPropagation();
                    activeWireStart = { 
                        comp: this, 
                        idx: i,
                        x: this.x + this.el.offsetWidth, 
                        y: this.y + 25 + i * 20 + 6 
                    };
                };
                this.el.appendChild(n);
            }
        }

        onStartDrag(e) {
            if (e.target.classList.contains('node') || e.target.classList.contains('delete-btn')) return;
            if (e.target.classList.contains('switch-btn') || e.target.classList.contains('btn-momentary')) return;
            
            selectedComponent = this;
            isDragging = this;
            dragOffsetX = e.clientX - this.x;
            dragOffsetY = e.clientY - this.y;
            showProps(this);
            document.querySelectorAll('.component').forEach(c => c.classList.remove('selected'));
            this.el.classList.add('selected');
        }

        remove() {
            wires = wires.filter(w => w.from !== this && w.to !== this);
            this.el.remove();
            components = components.filter(c => c !== this);
            propsPanel.style.display = 'none';
        }

        update() {
            const getIn = (idx) => {
                const w = wires.find(wire => wire.to === this && wire.toIdx === idx);
                return w ? w.from.voltageOut : 0;
            };

            const isHigh = (v) => v > 2.5;

            if (this.blown) { this.voltageOut = 0; return; }

            switch(this.type) {
                case 'BATTERY': 
                    this.voltageOut = this.value; 
                    break;
                    
                case 'CLOCK': 
                    this.voltageOut = (Math.floor(Date.now() / this.value) % 2) ? 5 : 0; 
                    break;
                    
                case 'SWITCH': 
                    this.voltageOut = this.state ? getIn(0) : 0; 
                    break;
                    
                case 'BUTTON': 
                    this.voltageOut = this.state ? 5 : 0; 
                    break;
                    
                case 'RESISTOR': 
                    this.voltageOut = getIn(0) * (1 / (this.value + 1)); 
                    const readout = this.el.querySelector('.readout');
                    if (readout) readout.innerText = this.value.toFixed(1) + 'Œ©';
                    break;
                    
                case 'CAPACITOR':
                    const inputV = getIn(0);
                    // Simple capacitor charging model
                    const diff = inputV - this.capacitorCharge;
                    this.capacitorCharge += diff * 0.1 / this.value;
                    this.voltageOut = this.capacitorCharge;
                    break;
                    
                case 'FUSE': 
                    const fuseIn = getIn(0);
                    this.voltageOut = fuseIn;
                    const current = fuseIn / 10; // Simplified current calculation
                    if (current > this.value) { 
                        this.blown = true; 
                        this.el.querySelector('.fuse-wire').classList.add('blown'); 
                    }
                    break;
                    
                case 'LIGHT':
                    const v = getIn(0);
                    const bulb = this.el.querySelector('.light-bulb');
                    if (bulb) {
                        const brightness = Math.min(v / 5 * 255, 255);
                        bulb.style.background = v > 1 ? `rgb(${brightness},${brightness},${100+v*15})` : '#333';
                        bulb.style.boxShadow = v > 1 ? `0 0 ${v*3}px rgba(255,255,100,0.8)` : 'none';
                    }
                    break;
                    
                case 'AND': 
                    this.voltageOut = (isHigh(getIn(0)) && isHigh(getIn(1))) ? 5 : 0; 
                    break;
                    
                case 'OR':  
                    this.voltageOut = (isHigh(getIn(0)) || isHigh(getIn(1))) ? 5 : 0; 
                    break;
                    
                case 'NOT': 
                    this.voltageOut = isHigh(getIn(0)) ? 0 : 5; 
                    break;
                    
                case 'NAND': 
                    this.voltageOut = !(isHigh(getIn(0)) && isHigh(getIn(1))) ? 5 : 0; 
                    break;
                    
                case 'NOR':  
                    this.voltageOut = !(isHigh(getIn(0)) || isHigh(getIn(1))) ? 5 : 0; 
                    break;
                    
                case 'XOR':  
                    this.voltageOut = (isHigh(getIn(0)) !== isHigh(getIn(1))) ? 5 : 0; 
                    break;
                    
                case 'SR_LATCH':
                    if (isHigh(getIn(0))) this.state = 5; // Set
                    if (isHigh(getIn(1))) this.state = 0; // Reset
                    this.voltageOut = this.state;
                    break;
                    
                case 'D_FF':
                    const clock = isHigh(getIn(1));
                    if (clock && !this.lastClock) {
                        this.state = isHigh(getIn(0)) ? 5 : 0;
                    }
                    this.lastClock = clock;
                    this.voltageOut = this.state;
                    break;
                    
                case '7SEG':
                    ['a','f','b','g','e','c','d'].forEach((s, i) => {
                        const seg = document.getElementById(this.id + s);
                        if (seg) seg.classList.toggle('on', isHigh(getIn(i)));
                    });
                    break;
                    
                case 'VOLTMETER':
                    const voltage = Math.abs(getIn(0) - getIn(1));
                    const vReadout = this.el.querySelector('.readout');
                    if (vReadout) vReadout.innerText = voltage.toFixed(2) + 'V';
                    break;
                    
                case 'AMMETER':
                    const curr = getIn(0);
                    const aReadout = this.el.querySelector('.readout');
                    if (aReadout) aReadout.innerText = (curr / 10).toFixed(2) + 'A';
                    this.voltageOut = curr;
                    break;
            }

            // Update node visuals based on voltage
            this.el.querySelectorAll('.node.output').forEach((node, idx) => {
                node.classList.toggle('active', this.voltageOut > 2.5);
            });
        }
    }

    function createComponent(type, x, y) {
        const c = new Component(type, x, y);
        components.push(c);
        return c;
    }

    function showProps(comp) {
        propsPanel.style.display = 'block';
        propsContent.innerHTML = `
            <div class="prop-label">Component Type</div>
            <div class="prop-value">${comp.type.replace('_', ' ')}</div>
        `;

        if (['BATTERY', 'CLOCK', 'RESISTOR', 'CAPACITOR', 'FUSE'].includes(comp.type)) {
            const label = comp.type === 'BATTERY' ? 'Voltage (V)' :
                         comp.type === 'CLOCK' ? 'Period (ms)' :
                         comp.type === 'RESISTOR' ? 'Resistance (Œ©)' :
                         comp.type === 'CAPACITOR' ? 'Capacitance (¬µF)' :
                         'Max Current (A)';
            
            const min = comp.type === 'CLOCK' ? 100 : 1;
            const max = comp.type === 'BATTERY' ? 24 : comp.type === 'CLOCK' ? 3000 : 100;
            
            propsContent.innerHTML += `
                <div class="prop-label" style="margin-top:12px">${label}</div>
                <input type="range" id="prop-range" min="${min}" max="${max}" value="${comp.value}" step="${comp.type === 'CLOCK' ? 100 : 0.1}">
                <div class="prop-value" id="prop-display">${comp.value.toFixed(1)}</div>
            `;
            
            const range = document.getElementById('prop-range');
            const display = document.getElementById('prop-display');
            
            range.oninput = () => { 
                comp.value = parseFloat(range.value);
                display.innerText = comp.value.toFixed(1);
                
                // Update component display
                const readout = comp.el.querySelector('.readout');
                if (readout) {
                    if (comp.type === 'BATTERY') readout.innerText = comp.value.toFixed(1) + 'V';
                    else if (comp.type === 'CLOCK') readout.innerText = comp.value + 'ms';
                    else if (comp.type === 'RESISTOR') readout.innerText = comp.value.toFixed(1) + 'Œ©';
                    else if (comp.type === 'CAPACITOR') readout.innerText = comp.value.toFixed(1) + '¬µF';
                    else if (comp.type === 'FUSE') readout.innerText = comp.value.toFixed(1) + 'A';
                }
            };
        }
        
        propsContent.innerHTML += `
            <div class="prop-label" style="margin-top:12px">Output Voltage</div>
            <div class="prop-value">${comp.voltageOut.toFixed(2)}V</div>
        `;
    }

    // Main Loop
    setInterval(() => {
        components.forEach(c => c.update());
        draw();
    }, 50);

    function draw() {
        canvas.width = workspace.clientWidth; 
        canvas.height = workspace.clientHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        wires.forEach(w => {
            const x1 = w.from.x + w.from.el.offsetWidth;
            const y1 = w.from.y + 25 + (w.fromIdx || 0) * 20 + 6;
            const x2 = w.to.x;
            const y2 = w.to.y + 25 + (w.toIdx * 20) + 6;
            
            ctx.beginPath();
            ctx.strokeStyle = w.from.voltageOut > 0.5 ? '#ffee58' : '#37474f';
            ctx.lineWidth = 3;
            ctx.moveTo(x1, y1);
            ctx.bezierCurveTo(x1 + 50, y1, x2 - 50, y2, x2, y2);
            ctx.stroke();
            
            // Add glow effect for active wires
            if (w.from.voltageOut > 0.5) {
                ctx.strokeStyle = 'rgba(255, 238, 88, 0.3)';
                ctx.lineWidth = 8;
                ctx.stroke();
            }
        });

        if (activeWireStart) {
            ctx.beginPath(); 
            ctx.strokeStyle = '#03a9f4'; 
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 2;
            ctx.moveTo(activeWireStart.x, activeWireStart.y);
            ctx.lineTo(mouseX, mouseY); 
            ctx.stroke(); 
            ctx.setLineDash([]);
        }
    }

    let mouseX, mouseY;
    
    window.onmousemove = (e) => {
        mouseX = e.clientX; 
        mouseY = e.clientY;
        if (isDragging) {
            isDragging.x = e.clientX - dragOffsetX;
            isDragging.y = e.clientY - dragOffsetY;
            isDragging.el.style.left = isDragging.x + 'px';
            isDragging.el.style.top = isDragging.y + 'px';
        }
    };
    
    window.onmouseup = () => { 
        isDragging = null; 
        activeWireStart = null;
    };

    // Click to place functionality
    workspace.onclick = (e) => {
        if (placingType && e.target === workspace) {
            const rect = workspace.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            createComponent(placingType, x - 40, y - 20);
            
            // Clear placing mode
            placingType = null;
            workspace.classList.remove('placing-mode');
            placingHint.style.display = 'none';
            document.querySelectorAll('.tool-item').forEach(item => item.classList.remove('placing'));
        }
    };

    // Drag and drop functionality
    workspace.ondragover = (e) => e.preventDefault();
    workspace.ondrop = (e) => {
        e.preventDefault();
        const type = e.dataTransfer.getData('type');
        if (type) {
            const rect = workspace.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            createComponent(type, x - 40, y - 20);
        }
    };

    // ESC key to cancel placing mode
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && placingType) {
            placingType = null;
            workspace.classList.remove('placing-mode');
            placingHint.style.display = 'none';
            document.querySelectorAll('.tool-item').forEach(item => item.classList.remove('placing'));
        }
    });

    document.getElementById('reset-btn').onclick = () => {
        if (confirm('Are you sure you want to reset all components and wires?')) {
            components.forEach(c => c.el.remove());
            components = []; 
            wires = [];
            propsPanel.style.display = 'none';
        }
    };

    document.getElementById('menu-toggle').onclick = () => {
        document.getElementById('toolbox').classList.toggle('collapsed');
    };
</script>
</body>
</html>
